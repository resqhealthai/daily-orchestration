<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVCH V7.0 - Fallback Logic</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; height: 100vh; color: white; font-family: sans-serif; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #status { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px; z-index: 100; }
    </style>
</head>
<body>
    <div id="status">Init V7.0...</div>
    <div id="container"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const MODE = params.get('mode'); // 'face', 'tablet', 'screen'
        const NAME = params.get('name') || 'MacMini-Participant';
        const PASSIVE = params.get('passive') === 'true'; // From AppleScript
        const ROOM_URL = params.get('url');

        const statusEl = document.getElementById('status');
        const container = document.getElementById('container');

        async function start() {
            if (!ROOM_URL) { statusEl.innerText = "ERR: No URL"; return; }
            statusEl.innerText = `Mode: ${MODE} | ${NAME}`;

            // 1. SETUP DAILY CALL
            const call = window.DailyIframe.createCallObject({
                dailyConfig: { experimentalChromeVideoMuteLightOff: true }
            });

            try {
                // 2. DEVICE SELECTION LOGIC (Index Based = Safer)
                let videoSource = false;
                let audioSource = false;

                if (PASSIVE) {
                    // SCREEN MODE: Send NOTHING
                    videoSource = false;
                    audioSource = false;
                    statusEl.innerText += " (Passive)";
                } 
                else {
                    // Get devices
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevs = devices.filter(d => d.kind === 'videoinput');
                    
                    if (videoDevs.length === 0) {
                        statusEl.innerText = "ERR: No Cameras Found";
                    }

                    if (MODE === 'face') {
                        // FACE: Prefer 1st device (Default System Cam)
                        videoSource = videoDevs[0] ? videoDevs[0].deviceId : true;
                        audioSource = true; 
                    } 
                    else if (MODE === 'tablet') {
                        // TABLET: Prefer 2nd device if exists (Capture Card), else 1st
                        // This prevents grabbing the webcam if possible
                        if (videoDevs.length > 1) {
                            videoSource = videoDevs[1].deviceId;
                            statusEl.innerText += ` (Using Cam 2: ${videoDevs[1].label})`;
                        } else {
                            videoSource = videoDevs[0] ? videoDevs[0].deviceId : true;
                            statusEl.innerText += ` (Using Cam 1: ${videoDevs[0]?.label})`;
                        }
                        audioSource = false; // Tablet has no mic
                    }
                }

                // 3. JOIN CALL
                await call.join({
                    url: ROOM_URL,
                    userName: NAME,
                    videoSource: videoSource,
                    audioSource: audioSource
                });
                
                // Hide status after success
                setTimeout(() => statusEl.style.display = 'none', 3000);

                // 4. DISPLAY LOGIC (What do we see?)
                call.on('track-started', (e) => {
                    if (e.participant.local && MODE !== 'tablet') return; // Only show local for tablet
                    
                    const track = e.track;
                    const isScreen = e.participant.screen;

                    // TABLET MODE: Show Self (Local)
                    if (MODE === 'tablet' && e.participant.local && track.kind === 'video') {
                        display(track);
                    }
                    
                    // SCREEN MODE: Show ONLY Screen Share
                    else if (MODE === 'screen' && isScreen && track.kind === 'video') {
                        display(track);
                    }

                    // FACE MODE: Show Remote Video (NOT Screen, NOT Tablet)
                    else if (MODE === 'face' && !isScreen && !e.participant.local && track.kind === 'video') {
                        display(track);
                    }
                    
                    // AUDIO: Always play remote audio (except for tablet mode which is an uplink)
                    if (track.kind === 'audio' && !e.participant.local && MODE !== 'tablet') {
                        const aud = document.createElement('audio');
                        aud.srcObject = new MediaStream([track]);
                        aud.autoplay = true;
                        document.body.appendChild(aud);
                    }
                });

            } catch (err) {
                statusEl.innerText = "ERR: " + err.message;
            }
        }

        function display(track) {
            container.innerHTML = '';
            const vid = document.createElement('video');
            vid.srcObject = new MediaStream([track]);
            vid.autoplay = true;
            vid.muted = true;
            container.appendChild(vid);
        }

        start();
    </script>
</body>
</html>
