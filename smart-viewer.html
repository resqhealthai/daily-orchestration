<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVCH V9.7 - Stable Logic</title>
    <style>
        body { 
            background: #000; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        /* Mode Specific Backgrounds for Setup phase */
        body.mode-face   { background-color: #001f3f; } /* Dark Blue */
        body.mode-screen { background-color: #111; }    /* Dark Gray */
        body.mode-tablet { background-color: #85144b; } /* Dark Red */

        /* Full Screen Video */
        video { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            z-index: 10; 
        }

        /* Status Overlay (Disappears when video starts) */
        #status {
            z-index: 20;
            color: white;
            font-family: monospace;
            font-size: 24px;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
    </style>
</head>
<body>

    <div id="status">V9.7 Initializing...</div>
    <div id="container"></div>

    <script>
        // === LOGGING HELPER ===
        const statusDiv = document.getElementById('status');
        function log(msg, isError = false) {
            console.log(msg);
            statusDiv.innerHTML = msg; // Update on-screen text
            if (isError) statusDiv.classList.add('error');
        }

        // === 1. ASYNC LOADER (Fixes the "Hanging" issue) ===
        function loadLibrary() {
            log("Loading Video Engine...");
            const script = document.createElement('script');
            script.src = "https://unpkg.com/@daily-co/daily-js";
            script.async = true;
            script.onload = () => startApp();
            script.onerror = () => log("CRITICAL ERROR: Internet blocked 'unpkg.com'.", true);
            document.head.appendChild(script);
        }

        // === 2. MAIN APPLICATION ===
        async function startApp() {
            try {
                const params = new URLSearchParams(window.location.search);
                const MODE = params.get('mode');
                const ROOM_URL = params.get('url');
                const NAME = params.get('name') || "ResQ-Node";

                if (!ROOM_URL) throw new Error("No URL provided in AppleScript.");
                document.body.classList.add(`mode-${MODE}`);
                log(`Mode: ${MODE.toUpperCase()} | Joining...`);

                // -- A. CREATE CALL --
                const call = window.DailyIframe.createCallObject({
                    dailyConfig: { experimentalChromeVideoMuteLightOff: true }
                });

                // -- B. HANDLE VIDEO STREAMS (THE LOGIC FILTER) --
                call.on('track-started', (e) => {
                    const p = e.participant;
                    const track = e.track;
                    if (track.kind !== 'video') return; // Ignore audio tracks here

                    let shouldDisplay = false;

                    // LOGIC RULES:
                    if (MODE === 'screen') {
                        // Monitor 2: Only show shared screens (remote)
                        if (!p.local && p.screen) shouldDisplay = true;
                    } 
                    else if (MODE === 'face') {
                        // Monitor 1: Show Remote Face (Not screen, Not local, Not Tablet)
                        if (!p.local && !p.screen && !p.user_name.includes("Tablet")) shouldDisplay = true;
                    } 
                    else if (MODE === 'tablet') {
                        // Tablet Window: Show LOCAL video (Self-Check)
                        // This lets us see if OBS is actually sending video
                        if (p.local) shouldDisplay = true;
                    }

                    if (shouldDisplay) {
                        displayVideo(track);
                    }
                });

                // -- C. DEVICE SELECTION --
                let vid = false;
                let aud = false;

                if (MODE !== 'screen') {
                    // Force permission prompt
                    await navigator.mediaDevices.getUserMedia({ video: true });
                    
                    const devs = await navigator.mediaDevices.enumerateDevices();
                    const vDevs = devs.filter(d => d.kind === 'videoinput');
                    
                    // KEYWORDS
                    const keyword = (MODE === 'face') ? "Logitech" : "OBS"; 
                    const target = vDevs.find(d => d.label.includes(keyword));

                    if (target) {
                        vid = target.deviceId;
                        aud = (MODE === 'face'); // Audio only on Face Monitor
                        log(`Camera Selected: ${target.label}`);
                    } else {
                        log(`WARNING: Camera '${keyword}' not found. Using Default.`, true);
                        // Fallback: If strict
