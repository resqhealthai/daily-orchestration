<!DOCTYPE html>
<html>
<head>
    <title>ResQ Smart Viewer</title>
    <meta charset="utf-8">
    <style>
        /* BASE LAYOUT */
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #000; overflow: hidden; }
        
        #debug {
            position: fixed; top: 10px; left: 10px; 
            color: #0f0; background: rgba(0,0,0,0.8);
            padding: 10px; font-family: monospace; font-size: 16px; 
            z-index: 20000; pointer-events: none; border: 1px solid #0f0;
        }
    </style>
    <script crossorigin src="https://unpkg.com/@daily-co/daily-js"></script>
</head>
<body>
    <div id="debug">Initializing...</div>
    
    <script>
        let callFrame = null;
        let joinStatus = "Waiting for SDK...";
        let loopCount = 0;

        // 1. SDK CHECK (Safety first)
        const sdkCheck = setInterval(() => {
            if (window.DailyIframe) {
                clearInterval(sdkCheck);
                init();
            }
        }, 500);

        // 2. MAIN INIT
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const roomUrl = params.get('roomUrl');
            const mode = params.get('mode') || 'face';

            if (!roomUrl) { joinStatus = "Error: No roomUrl"; updateDebug(); return; }

            // === 3. THE CSS FILTER STRATEGY ===
            // We inject this directly into the Daily Iframe to control the layout
            let injectedCSS = `
                /* GLOBAL RESET: Hide the self-view */
                .daily-video-div.local { display: none !important; }
                
                /* GLOBAL: Force ALL video tiles to be full screen (overlapping) */
                .daily-video-div {
                    position: fixed !important;
                    top: 0 !important; left: 0 !important;
                    width: 100vw !important; height: 100vh !important;
                    z-index: 1; /* Base Level */
                    background: #000;
                }
            `;

            if (mode === 'face') {
                // FACE MODE:
                // 1. Hide Screen Shares
                // 2. Camera tiles remain visible (and full screen due to global rule above)
                injectedCSS += `
                    .daily-screen-share { display: none !important; }
                `;
            } 
            else if (mode === 'screen') {
                // SCREEN MODE:
                // 1. Force Screen Shares to Top Layer (Z-Index 100)
                // 2. Camera tiles sit underneath (effectively hidden)
                injectedCSS += `
                    .daily-screen-share { 
                        display: block !important; 
                        z-index: 100 !important; 
                    }
                `;
            }

            // Create Frame with CSS
            callFrame = window.DailyIframe.createFrame(document.body, {
                showLeaveButton: false,
                showFullscreenButton: false,
                showUserName: false,
                cssText: injectedCSS, // <--- INJECT THE RULES
                iframeStyle: {
                    position: 'fixed', top: '0', left: '0', width: '100%', height: '100%', border: '0', zIndex: '1'
                }
            });

            joinStatus = `Joining (${mode})...`;
            updateDebug();

            try {
                await callFrame.join({ 
                    url: roomUrl,
                    showLocalVideo: false,
                    startVideoOff: true,
                    startAudioOff: false,
                    userName: `Display-${mode.toUpperCase()}`,
                    
                    // CONFIGURATION:
                    subscribeToTracksAutomatically: true, // FASTEST CONNECTION
                    activeSpeakerMode: false // GRID MODE (Renders both Camera + Screen tiles)
                });
                joinStatus = "Active";
            } catch(e) {
                joinStatus = `Error: ${e.message}`;
            }
        }

        // 4. STATUS LOOP
        setInterval(() => {
            loopCount++;
            updateDebug();
        }, 1000);

        function updateDebug() {
            const d = document.getElementById('debug');
            if (d) d.innerText = `Loop: ${loopCount}\nStatus: ${joinStatus}`;
        }
    </script>
</body>
</html>
