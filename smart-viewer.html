<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVCH Orchestrator V6.3 - Tablet Self-View</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        /* --- 1. VISUALS & GRAPHIC --- */
        body { 
            margin: 0; padding: 0; 
            overflow: hidden; 
            height: 100vh; 
            background-color: #000;
            display: flex; 
            justify-content: center; 
            align-items: center;
            background-image: url('https://placehold.co/1920x1080/222222/FFFFFF?text=ResQ+Health+Training+Center'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
        }

        /* --- 2. VIDEO LAYOUT --- */
        video { 
            width: 100%; height: 100%; 
            object-fit: contain; 
            position: absolute; 
            z-index: 10; 
            background: #000; 
        }

        /* --- 3. UI LAYER --- */
        #ui-layer {
            z-index: 20;
            position: relative;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
            display: none;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div id="call-container"></div>
    <div id="ui-layer">
        <h2 id="status-text">Initializing...</h2>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const ROOM_URL = params.get('url'); 
        const MODE = params.get('mode'); 
        
        // --- TITLE ENFORCER ---
        const CUSTOM_TITLE = params.get('title');
        if (CUSTOM_TITLE) {
            document.title = CUSTOM_TITLE;
            const titleObserver = new MutationObserver(() => {
                if (document.title !== CUSTOM_TITLE) document.title = CUSTOM_TITLE;
            });
            const titleEl = document.querySelector('title');
            if (titleEl) titleObserver.observe(titleEl, { childList: true, characterData: true, subtree: true });
        }

        const TABLET_CAM_NAME = params.get('camera') || 'OBS'; 

        // --- 1. CONFIGURE CALL ---
        let callOptions = {
            url: ROOM_URL,
            subscribeToTracksAutomatically: false,
            dailyConfig: { experimentalChromeVideoMuteLightOff: true }
        };

        // For V6.3, we allow videoSource: true initially if tablet, just in case
        if (MODE === 'face') {
            callOptions.audioSource = true; callOptions.videoSource = true;
        } else if (MODE === 'tablet') {
            callOptions.audioSource = false; callOptions.videoSource = false; 
        } else {
            callOptions.audioSource = false; callOptions.videoSource = false;
        }

        const call = window.DailyIframe.createCallObject(callOptions);

        // --- 2. REMOTE VIDEO LOGIC ---
        call.on('track-started', (e) => {
            const p = e.participant;
            const track = e.track;

            // V6.3 CHANGE: Allow LOCAL video render only for Tablet Mode (for debugging/confidence)
            if (p.local && MODE !== 'tablet') return; 

            const isTablet = (p.user_name || "").includes("MacMini-Tablet");
            const isScreenShare = p.screen;
            const container = document.getElementById('call-container');

            // TABLET MODE (Local Self-View)
            if (MODE === 'tablet' && p.local && track.kind === 'video') {
                 console.log("Rendering Local Tablet Feed");
                 renderVideo(track, container);
            }

            // FACE MODE
            if (MODE === 'face') {
                if (track.kind === 'video' && !isScreenShare && !isTablet && !p.local) {
                    renderVideo(track, container);
                }
                if (track.kind === 'audio' && !p.local) playAudio(track);
            }

            // SCREEN MODE
            else if (MODE === 'screen') {
                if (track.kind === 'video' && (isScreenShare || isTablet) && !p.local) {
                    renderVideo(track, container);
                }
            }
        });

        call.on('track-stopped', (e) => {
             // Only clear if it's the track we are currently watching
             // For tablet mode, we don't want to clear our own feed accidentally
             if (!e.participant.local || (MODE === 'tablet' && e.participant.local)) {
                // simple check: usually we just clear
             }
        });

        // --- 3. STARTUP LOGIC ---
        async function start() {
            const ui = document.getElementById('ui-layer');
            const status = document.getElementById('status-text');

            if (!ROOM_URL) {
                status.innerText = "ERR: No URL Provided";
                ui.style.display = 'block';
                return;
            }

            try {
                if (MODE === 'tablet') {
                    status.innerText = "Searching for Tablet Feed...";
                    ui.style.display = 'block';

                    const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const targetDevice = devices.find(d => 
                        d.kind === 'videoinput' && 
                        d.label.toLowerCase().includes(TABLET_CAM_NAME.toLowerCase())
                    );
                    tempStream.getTracks().forEach(t => t.stop());

                    if (!targetDevice) throw new Error(`Device '${TABLET_CAM_NAME}' not found.`);

                    status.innerText = `Linking: ${targetDevice.label}`;
                    
                    await call.join({ 
                        userName: 'MacMini-Tablet',
                        videoSource: targetDevice.deviceId,
                        audioSource: false
                    });

                    // FORCE UNMUTE (V6.3 Fix)
                    call.setLocalVideo(true);

                    ui.style.display = 'none';
                } 
                else if (MODE === 'face') {
                    await call.join({ userName: 'MacMini-Classroom' });
                }
                else {
                    await call.join({ userName: 'MacMini-ScreenDisp' });
                    call.updateParticipant('*', { setSubscribedTracks: true });
                }

            } catch (err) {
                ui.style.display = 'block';
                status.innerText = "Error: " + err.message;
                console.error(err);
            }
        }

        function renderVideo(track, container) {
            container.innerHTML = ''; 
            const videoEl = document.createElement('video');
            videoEl.srcObject = new MediaStream([track]);
            videoEl.autoplay = true;
            videoEl.muted = true; // Always mute video elements to prevent feedback
            videoEl.playsInline = true;
            container.appendChild(videoEl);
        }

        function playAudio(track) {
            const audioEl = document.createElement('audio');
            audioEl.srcObject = new MediaStream([track]);
            audioEl.autoplay = true;
            document.body.appendChild(audioEl);
        }

        start();
    </script>
</body>
</html>
