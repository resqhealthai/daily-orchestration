<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Viewer v13.0</title>
    <style>
        body { 
            background: #000; margin: 0; overflow: hidden; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: sans-serif; color: white;
        }
        
        /* THE TRIGGER BUTTON */
        #launch-btn {
            font-size: 40px; padding: 20px 50px; background: #2ECC40; color: #fff;
            border: none; border-radius: 10px; cursor: pointer; z-index: 100;
            box-shadow: 0 0 20px #2ECC40; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #status { margin-top: 20px; font-size: 20px; color: #888; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 10; background: black; display: none; }
    </style>
</head>
<body>

    <button id="launch-btn" onclick="startEngine()">LAUNCH SYSTEM</button>
    <div id="status">WAITING FOR TRIGGER...</div>

    <div id="container"></div>

    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <script>
        // 1. CONFIG
        var params = new URLSearchParams(window.location.search);
        var MODE = params.get('mode');
        var URL = params.get('url') ? params.get('url').trim().replace(/"/g, '') : "";
        var NAME = params.get('name') || "Smart-Viewer";
        
        var btn = document.getElementById('launch-btn');
        var stat = document.getElementById('status');
        var container = document.getElementById('container');

        // 2. THE ENGINE (Triggered by Click)
        function startEngine() {
            btn.style.display = 'none'; // Hide button
            stat.innerText = "AUTHENTICATING...";
            
            try {
                // CREATE CALL OBJECT (Headless Mode)
                var call = window.DailyIframe.createCallObject({
                    dailyConfig: { 
                        avoidEval: true,
                        experimentalChromeVideoMuteLightOff: true 
                    }
                });

                call.on('track-started', handleVideo);
                call.on('error', (e) => { stat.innerText = "ERROR: " + e.errorMsg; });
                call.on('joined-meeting', () => { 
                    stat.style.display = 'none'; // Hide text on success
                });

                // JOIN
                stat.innerText = "CONNECTING...";
                
                // Mode-specific Join settings
                let settings = { url: URL, userName: NAME };
                
                // Ghost/Monitor Mode (No Mic/Cam) to prevent permission blocks
                if (MODE !== 'tablet') {
                    settings.audioSource = false;
                    settings.videoSource = false;
                }
                
                call.join(settings).catch(e => { stat.innerText = "JOIN FAILED: " + e; });

            } catch(e) {
                stat.innerText = "CRASH: " + e.message;
            }
        }

        // 3. VIDEO ROUTER (The Magic Logic)
        function handleVideo(e) {
            var p = e.participant;
            if (p.local) return; // Never show self (unless Tablet loopback needed)

            // LOGIC: Which stream goes to which monitor?
            var show = false;

            if (MODE === 'face') {
                // Monitor 1: Show Instructor Face (Ignore Screen Shares)
                if (!p.screen && !p.user_name.includes("Tablet")) show = true;
            } 
            else if (MODE === 'screen') {
                // Monitor 2: Show Screen Share ONLY
                if (p.screen) show = true;
            }
            else if (MODE === 'tablet') {
                // Tablet: Can see whatever (usually Instructor Face)
                if (!p.screen) show = true;
            }

            if (show) {
                // Remove old video
                container.innerHTML = ''; 
                
                // Create new video
                var el = document.createElement('video');
                el.srcObject = new MediaStream([e.track]);
                el.autoplay = true; 
                el.muted = true;
                el.style.display = 'block';
                container.appendChild(el);
            }
        }
    </script>
</body>
</html>
