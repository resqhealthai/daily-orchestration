-- ============================================================
-- ResQ Health Training System - CVCH Orchestrator (V10.9)
-- Fixes: Trims hidden newlines/spaces + Verifies URL with Popup
-- Matches: Smart Viewer v11.7 (or newer)
-- ============================================================

property viewerBaseURL : "https://resqhealthai.github.io/daily-orchestration/smart-viewer.html"
property configURL : "https://raw.githubusercontent.com/resqhealthai/daily-orchestration/main/config.json"

-- APP CONFIG
property scrcpyCommand : "/opt/homebrew/bin/scrcpy"
property chromeProfile : "Profile 28"

-- MONITOR CONFIG
property mon1_W : 1920
property mon1_H : 1080
property mon2_W : 2048
property mon2_Y_Start : -250
property mon2_H_Forced : 1600

on run
    try
        -- 0. CLEAN SLATE
        tell application "Safari" to quit
        delay 2
        
        -- 1. LAUNCH DEPENDENCIES
        my launchDependencies()
        
        -- 2. FETCH & PARSE CONFIGURATION
        set macMiniName to do shell script "scutil --get ComputerName"
        set configJSON to do shell script "curl -s --max-time 10 " & quoted form of configURL
        
        -- PARSE JSON
        set rawURL to my getRoomUrlFromJSON(configJSON, macMiniName)
        
        if rawURL is missing value or rawURL is "" then
            error "FAILED LOOKUP. Mac Name: [" & macMiniName & "]. Could not find match in config.json."
        end if
        
        -- TRIM WHITESPACE (The Fix for the "Joining" Hang)
        set fullRoomURL to my trimText(rawURL)
        
        -- *** VERIFICATION POPUP ***
        display dialog "Verifying Room URL for " & macMiniName & ":" & return & return & fullRoomURL buttons {"Cancel", "Confirm & Launch"} default button "Confirm & Launch"
        
        -- Generate Cache-Busted URLs
        set timestamp to do shell script "date +%s"
        set baseWithCache to viewerBaseURL & "?v=" & timestamp
        
        -- URL ENCODE
        set safeRoomURL to my urlEncode(fullRoomURL)
        
        set faceURL to baseWithCache & "&url=" & safeRoomURL & "&mode=face&name=MacMini-Classroom"
        set screenURL to baseWithCache & "&url=" & safeRoomURL & "&mode=screen&name=Monitor-2-Rx&passive=true"
        set tabletURL to baseWithCache & "&url=" & safeRoomURL & "&mode=tablet&name=MacMini-Tablet"
        
        -- 3. LAUNCH CHROME (TABLET UPLINK)
        set chromeCmd to "/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome"
        set args to " --new-window --profile-directory=" & quoted form of chromeProfile & " " & quoted form of tabletURL
        do shell script chromeCmd & args & " > /dev/null 2>&1 &"
        
        delay 10
        
        -- 4. LAUNCH SAFARI (MONITORS)
        tell application "Safari"
            activate
            
            -- Win 1 (Face)
            make new document with properties {URL:faceURL}
            set bounds of window 1 to {0, 0, mon1_W, mon1_H}
            my safeToggleUI()
            
            -- Win 2 (Screen)
            make new document with properties {URL:screenURL}
            set bounds of window 1 to {mon1_W, mon2_Y_Start, (mon1_W + mon2_W), mon2_H_Forced}
            my safeToggleUI()
        end tell
        
        return "SUCCESS - ORCHESTRATOR V10.9"
    on error errMsg
        return "CRASH: " & errMsg
    end try
end run

-- ============================================================
-- HELPERS
-- ============================================================

on launchDependencies()
    try
        do shell script "open -b 'com.obsproject.obs-studio' --args --startvirtualcam"
        delay 5 
    on error
        display dialog "Could not find OBS." buttons {"OK"}
    end try
    try
        do shell script "pgrep -x scrcpy"
    on error
        tell application "Terminal"
            do script scrcpyCommand
            activate
        end tell
        delay 3
    end try
end launchDependencies

on safeToggleUI()
    try
        tell application "System Events" to tell process "Safari"
            if exists (menu item "Hide Toolbar" of menu "View" of menu bar 1) then
                click menu item "Hide Toolbar" of menu "View" of menu bar 1
            end if
        end tell
    end try
end safeToggleUI

-- SMART JSON PARSER
on getRoomUrlFromJSON(jsonString, macName)
    try
        set jsScript to "var config = " & jsonString & "; " & ¬
            "var search = '" & macName & "'.toLowerCase().replace(/\\s/g, ''); " & ¬
            "var locs = config['locations'] || {}; " & ¬
            "var foundKey = Object.keys(locs).find(k => k.toLowerCase().replace(/\\s/g, '') === search); " & ¬
            "var target = foundKey ? locs[foundKey] : null; " & ¬
            "target ? target.roomUrl : '';"
        set resultURL to run script jsScript in "JavaScript"
        return resultURL
    on error
        return missing value
    end try
end getRoomUrlFromJSON

-- TRIM WHITESPACE (Removes invisible newlines)
on trimText(theText)
    set js to "var str = '" & theText & "'; str.trim();"
    return run script js in "JavaScript"
end trimText

-- URL CLEANER
on urlEncode(str)
    set js to "encodeURIComponent('" & str & "')"
    return run script js in "JavaScript"
end urlEncode
