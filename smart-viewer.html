<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Viewer v15.0</title>
    <style>
        body { 
            background: #000; margin: 0; overflow: hidden; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: sans-serif; color: white;
        }
        #status { font-size: 24px; font-weight: bold; color: #888; }
        
        /* VIDEO LAYOUT - FULL SCREEN */
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 10; background: black; }
        
        /* HIDE SCROLLBARS */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="status">INITIALIZING SYSTEM...</div>
    <div id="container"></div>

    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <script>
        // 1. CONFIGURATION
        var params = new URLSearchParams(window.location.search);
        var MODE = params.get('mode'); // 'face', 'screen', 'tablet'
        var URL = params.get('url') ? params.get('url').trim().replace(/"/g, '') : "";
        var NAME = params.get('name') || "Smart-Viewer";
        
        var stat = document.getElementById('status');
        var container = document.getElementById('container');

        // 2. START IMMEDIATELY
        if (!URL) {
            stat.innerText = "CONFIG ERROR: No URL Found";
        } else {
            initCall();
        }

        function initCall() {
            stat.innerText = "CONNECTING...";
            
            try {
                // CREATE CALL (Headless - No UI)
                var call = window.DailyIframe.createCallObject({
                    dailyConfig: { 
                        experimentalChromeVideoMuteLightOff: true 
                    }
                });

                call.on('track-started', handleVideo);
                call.on('error', (e) => { stat.innerText = "ERROR: " + e.errorMsg; });
                call.on('joined-meeting', () => { stat.innerText = "WAITING FOR VIDEO..."; });

                // 3. JOIN LOGIC (THE FIX)
                // Monitors must be PASSIVE (Audio: False, Video: False)
                // Tablet is ACTIVE (Audio: True, Video: True)
                
                let joinOptions = { 
                    url: URL, 
                    userName: NAME 
                };

                if (MODE === 'tablet') {
                    // TABLET: Active Uplink
                    joinOptions.audioSource = true;
                    joinOptions.videoSource = true; 
                } else {
                    // MONITORS: Passive Display (CRITICAL FIX)
                    // We explicitly force false to prevent Hardware Conflict
                    joinOptions.audioSource = false;
                    joinOptions.videoSource = false;
                }
                
                // EXECUTE JOIN
                call.join(joinOptions).catch(e => { stat.innerText = "JOIN FAILED: " + e; });

            } catch(e) {
                stat.innerText = "CRASH: " + e.message;
            }
        }

        // 4. VIDEO ROUTING
        function handleVideo(e) {
            var p = e.participant;
            if (p.local && MODE !== 'tablet') return; // Hide self unless testing

            var show = false;

            if (MODE === 'face') {
                // Monitor 1: Show Instructor Face (Ignore Screen Shares & Tablet)
                if (!p.screen && !p.user_name.includes("Tablet")) show = true;
            } 
            else if (MODE === 'screen') {
                // Monitor 2: Show Screen Share ONLY
                if (p.screen) show = true;
            }
            else if (MODE === 'tablet') {
                // Tablet: Can see Instructor
                if (!p.screen && !p.local) show = true;
            }

            if (show) {
                // Clear status text
                stat.style.display = 'none';
                
                // Render Video
                container.innerHTML = ''; 
                var el = document.createElement('video');
                el.srcObject = new MediaStream([e.track]);
                el.autoplay = true; 
                el.muted = true;
                container.appendChild(el);
            }
        }
    </script>
</body>
</html>
