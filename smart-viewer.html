<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResQ Smart Viewer</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        body { margin: 0; padding: 0; background: black; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #status { position: absolute; top: 10px; left: 10px; color: lime; font-family: monospace; z-index: 100; pointer-events: none; background: rgba(0,0,0,0.5); padding: 5px;}
    </style>
</head>
<body>
    <div id="status">Waiting for 'Instructor'...</div>
    <video id="videoEl" autoplay playsinline></video>
    <audio id="audioEl" autoplay></audio>

    <script>
        const setStatus = (msg) => document.getElementById('status').innerText = msg;
        const log = (msg) => console.log(`[SmartViewer] ${msg}`);

        // 1. PARAMS
        const params = new URLSearchParams(window.location.search);
        const ROOM_URL = params.get('roomUrl') || params.get('url'); 
        const MODE = params.get('mode') || 'face';

        if (!ROOM_URL) throw new Error("Missing Room URL");

        // 2. CONFIG
        const isPassiveMode = (MODE === 'screen');
        const call = window.DailyIframe.createCallObject({
            userName: `MacMini-${MODE}`, // We name ourselves clearly
            subscribeToTracksAutomatically: false, // Manual Control
            videoSource: !isPassiveMode, 
            audioSource: !isPassiveMode,
            dailyConfig: { experimentalChromeVideoMuteLightOff: true }
        });

        const videoEl = document.getElementById('videoEl');
        const audioEl = document.getElementById('audioEl');

        // 3. THE SIMPLE LOGIC: ONLY "Instructor" EXISTS
        const isInstructor = (p) => {
            // Check if name contains "Instructor" (case insensitive)
            return (p.user_name || "").toLowerCase().includes("instructor");
        };

        const updateSubscriptions = (p) => {
            if (!isInstructor(p)) return; // Ignore everyone else

            log(`Found Instructor! Subscribing...`);
            setStatus(`Instructor Connected.`);

            let subs = { audio: false, video: false, screenVideo: false };
            if (MODE === 'face') {
                subs = { audio: true, video: true, screenVideo: false };
            } else if (MODE === 'screen') {
                subs = { audio: false, video: false, screenVideo: true };
            }
            call.updateParticipant(p.session_id, { setSubscribedTracks: subs });
        };

        const handleTrack = (evt) => {
            const p = evt.participant;
            const track = evt.track;

            if (!p || !track) return;
            if (!isInstructor(p)) return; // Ignore non-instructors

            // Mode Check
            if (MODE === 'face') {
                if (track.kind === 'video' && p.screen) return;
            } else if (MODE === 'screen') {
                if (track.kind === 'video' && !p.screen) return;
            }

            const targetEl = track.kind === 'video' ? videoEl : audioEl;
            if (targetEl.srcObject?.id === track.id) return;

            log(`Playing ${track.kind} track`);
            targetEl.srcObject = new MediaStream([track]);
            targetEl.play().catch(console.error);
        };

        // 4. EVENTS
        call.on('participant-joined', (evt) => updateSubscriptions(evt.participant));
        call.on('participant-updated', (evt) => updateSubscriptions(evt.participant));
        call.on('track-started', handleTrack);

        call.on('joined-meeting', (evt) => {
            log("Joined. Scanning for 'Instructor'...");
            const participants = call.participants();
            for (const id in participants) {
                updateSubscriptions(participants[id]);
            }
        });

        call.join({ url: ROOM_URL });
    </script>
</body>
</html>
