<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVCH V11.0 - Graphics UI</title>
    <style>
        /* BASE STYLES */
        body { 
            background: #000; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: white;
        }

        /* VIDEO LAYER (Initially Hidden) */
        video { 
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; 
            z-index: 10; 
            background: black; /* Fills gaps if aspect ratio differs */
        }

        /* WAITING GRAPHIC LAYER */
        #placeholder {
            z-index: 5;
            text-align: center;
            opacity: 0.8;
            transition: opacity 0.5s;
        }
        .icon { font-size: 80px; margin-bottom: 20px; display: block; }
        .text { font-size: 24px; letter-spacing: 2px; text-transform: uppercase; font-weight: 300; }
        .subtext { font-size: 14px; color: #888; margin-top: 10px; }

        /* MODE SPECIFIC COLORS (For Borders/Backgrounds) */
        body.mode-face #placeholder   { color: #7FDBFF; } /* Blue Text */
        body.mode-screen #placeholder { color: #2ECC40; } /* Green Text */
        body.mode-tablet #placeholder { color: #FF4136; } /* Red Text */

        /* LOGGING OVERLAY (Small, Top Left) */
        #console {
            position: absolute; top: 10px; left: 10px;
            font-family: monospace; font-size: 12px; color: #555;
            z-index: 100; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="placeholder">
        <span id="icon" class="icon">‚è≥</span>
        <div id="status-text" class="text">INITIALIZING...</div>
        <div id="sub-text" class="subtext">V11.0</div>
    </div>

    <div id="container"></div>

    <div id="console"></div>

    <script>
        // === CONFIGURATION ===
        const con = document.getElementById('console');
        const ph = document.getElementById('placeholder');
        const icon = document.getElementById('icon');
        const txt = document.getElementById('status-text');
        const sub = document.getElementById('sub-text');

        function log(msg) {
            con.innerText = `> ${msg}`;
            console.log(msg);
        }

        // === 1. SETUP UI BASED ON MODE ===
        const params = new URLSearchParams(window.location.search);
        const MODE = params.get('mode');
        const NAME = params.get('name');
        const URL = params.get('url');

        document.body.classList.add(`mode-${MODE}`);

        function updatePlaceholder() {
            if (MODE === 'face') {
                icon.innerText = "üë§";
                txt.innerText = "Waiting for Instructor";
                sub.innerText = "Monitor 1";
            } else if (MODE === 'screen') {
                icon.innerText = "üñ•Ô∏è";
                txt.innerText = "Waiting for Screen Share";
                sub.innerText = "Monitor 2";
            } else if (MODE === 'tablet') {
                icon.innerText = "üì°";
                txt.innerText = "Tablet Uplink Active";
                sub.innerText = "Sending Video...";
            }
        }
        updatePlaceholder(); // Set initial state

        // === 2. LOAD LIBRARY ===
        function loadLib() {
            const script = document.createElement('script');
            script.src = "https://unpkg.com/@daily-co/daily-js";
            script.async = true;
            script.onload = () => runApp();
            script.onerror = () => { txt.innerText = "NETWORK ERROR"; sub.innerText = "Check Internet"; };
            document.head.appendChild(script);
        }

        // === 3. MAIN APP ===
        async function runApp() {
            try {
                if (MODE === 'tablet') {
                    // Stagger logic preserved for Tablet
                    sub.innerText = "Yielding to Face Cam (8s)...";
                    await new Promise(r => setTimeout(r, 8000));
                    sub.innerText = "Connecting...";
                }

                const call = window.DailyIframe.createCallObject({
                    dailyConfig: { experimentalChromeVideoMuteLightOff: true }
                });

                // --- TRACK HANDLERS (Video ON/OFF Logic) ---
                
                // A. Video Started
                call.on('track-started', (e) => {
                    if (e.track.kind !== 'video') return;
                    const p = e.participant;
                    
                    if (shouldShow(p)) {
                        log(`SHOWING: ${p.user_name}`);
                        displayVideo(e.track);
                    }
                });

                // B. Video Stopped (Crucial for Screen Share ending)
                call.on('track-stopped', (e) => {
                    // Check if the track that stopped is the one we were showing
                    // Simple logic: If we have a video element, check if it's dead
                    setTimeout(() => {
                        const videoEl = document.querySelector('video');
                        // If track is muted or removed, revert to placeholder
                        if (videoEl && videoEl.srcObject.getVideoTracks()[0].readyState === 'ended') {
                            log("Video Ended. Reverting to Placeholder.");
                            clearVideo();
                        }
                    }, 500);
                });
                
                // Also listen for participant-left to clear screen
                call.on('participant-left', (e) => {
                    // If the current video belongs to the person who left, clear it
                    // (Simplification: Just clear video on any leave to force refresh/check)
                    // Better: We rely on track-stopped, but this is a fallback.
                });


                // --- DEVICE & JOIN ---
                let vid = false;
                let aud = false;

                if (MODE !== 'screen') {
                    try {
                        await navigator.mediaDevices.getUserMedia({ video: true });
                        const devs = await navigator.mediaDevices.enumerateDevices();
                        const vDevs = devs.filter(d => d.kind === 'videoinput');
                        const keyword = (MODE === 'face') ? "Logitech" : "OBS";
                        const target = vDevs.find(d => d.label.includes(keyword));

                        if (target) {
                            vid = target.deviceId;
                            aud = (MODE === 'face');
                        } else {
                            log(`${keyword} not found. Using Default.`);
