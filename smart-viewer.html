<!DOCTYPE html>
<html>
<head>
    <title>ResQ Smart Viewer</title>
    <meta charset="utf-8">
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        .error { color: #ff4444; padding: 40px; text-align: center; margin-top: 20%; }
        /* Base style for all videos: absolute full screen */
        .daily-video-div {
            position: fixed !important;
            top: 0 !important; 
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1;
        }
    </style>
    <script crossorigin src="https://api.daily.co/daily.js"></script>
</head>
<body>
    <div id="error-msg" class="error" style="display:none;"></div>
    
    <script>
        function showError(title, detail) {
            const el = document.getElementById('error-msg');
            el.style.display = 'block';
            el.innerHTML = `<h1>${title}</h1><p>${detail || ''}</p>`;
        }

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const roomUrl = params.get('roomUrl');
            const mode = params.get('mode') || 'face';

            if (!roomUrl) { showError("Config Error", "No roomUrl"); return; }

            // 1. CREATE FRAME
            const callFrame = window.DailyIframe.createFrame(document.body, {
                showLeaveButton: false,
                showFullscreenButton: false,
                iframeStyle: { width: '100%', height: '100%', border: '0', zIndex: 9999 }
            });

            console.log(`Joining ${roomUrl} in ${mode} mode...`);

            try {
                // 2. JOIN (Force Grid/Active Speaker OFF)
                await callFrame.join({ 
                    url: roomUrl,
                    showLocalVideo: false,
                    startVideoOff: true,
                    startAudioOff: false,
                    userName: `Display-${mode.toUpperCase()}`,
                    activeSpeakerMode: false // Grid Mode
                });

                // 3. START LAYOUT ENFORCER LOOP
                // This runs every 500ms to audit the DOM and force visibility
                setInterval(() => {
                    enforceLayout(mode);
                }, 500);

            } catch (e) {
                showError("Join Failed", e.message);
            }
        }

        // === THE LOGIC ENGINE ===
        function enforceLayout(mode) {
            // Get all video containers injected by Daily
            const videos = document.querySelectorAll('.daily-video-div');
            
            videos.forEach(div => {
                // Check if this tile is a Screen Share
                const isScreen = div.classList.contains('daily-screen-share');
                
                // Check if this tile is Self (Local)
                const isLocal = div.classList.contains('local');

                if (isLocal) {
                    // ALWAYS hide self
                    div.style.display = 'none';
                    return;
                }

                if (mode === 'face') {
                    // FACE MODE: 
                    // Show Camera (Not Screen), Hide Screen
                    if (isScreen) {
                        div.style.display = 'none';
                    } else {
                        div.style.display = 'block';
                        div.style.zIndex = '100'; // Bring to front
                    }
                } 
                else if (mode === 'screen') {
                    // SCREEN MODE:
                    // Show Screen, Hide Camera
                    if (isScreen) {
                        div.style.display = 'block';
                        div.style.zIndex = '100'; // Bring to front
                    } else {
                        div.style.display = 'none';
                    }
                }
            });
        }

        window.addEventListener('load', () => setTimeout(init, 500));
    </script>
</body>
</html>
