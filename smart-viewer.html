<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVCH Smart Viewer V4.0</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        /* 1. VISUAL SETUP & STANDBY GRAPHIC */
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            height: 100vh; 
            background-color: #000;
            display: flex; 
            justify-content: center; 
            align-items: center;

            /* RESTORED: The Standby Graphic */
            background-image: url('https://placehold.co/1920x1080/222222/FFFFFF?text=Awaiting+ResQ+Health+Instructor'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
        }

        /* 2. VIDEO ELEMENT (Covers the graphic when active) */
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            position: absolute; 
            z-index: 10; 
            background: #000; /* Solid black background for the video itself */
        }

        /* 3. IPAD MODE UI */
        #ipad-ui {
            z-index: 20;
            text-align: center;
            color: white;
            font-family: sans-serif;
            background: rgba(0,0,0,0.7);
            padding: 2rem;
            border-radius: 10px;
            display: none; /* Hidden by default */
        }
        button { font-size: 20px; padding: 10px 20px; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>
    <div id="call-container"></div>
    
    <div id="ipad-ui">
        <h2>iPad Broadcast Mode</h2>
        <p>Click below to select the <strong>Reflector 4</strong> window.</p>
        <button id="shareBtn">Start Sharing</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const params = new URLSearchParams(window.location.search);
        const ROOM_URL = params.get('url'); 
        const MODE = params.get('mode'); // 'face', 'screen', or 'ipad'

        if (!ROOM_URL) document.body.innerHTML = "<h1 style='color:red'>ERR: No URL</h1>";

        // --- 1. SETUP CALL OBJECT (HEADLESS) ---
        const call = window.DailyIframe.createCallObject({
            subscribeToTracksAutomatically: false, // We will manually subscribe based on Mode
            dailyConfig: { experimentalChromeVideoMuteLightOff: true }
        });

        // --- 2. PARTICIPANT FILTERING (The "Old Code" Logic) ---
        // Prevents windows from subscribing to each other or the iPad
        const isSafeParticipant = (p) => {
            if (p.local) return false;
            const name = (p.user_name || "").toLowerCase();
            // Ignore other orchestrator windows to prevent loops
            if (name.includes("macmini") || name.includes("ipad")) return false; 
            return true;
        };

        // --- 3. TRACK HANDLING ---
        call.on('track-started', (e) => {
            const p = e.participant;
            if (!isSafeParticipant(p)) return;

            const track = e.track;
            const isScreenShare = p.screen;
            const container = document.getElementById('call-container');

            // --- MODE: FACE (Window 1) ---
            // Shows: Camera Video
            // Plays: ALL Audio (Mic + System Audio from screen share)
            if (MODE === 'face') {
                // Video Logic: Only show if it's a Camera (not screen)
                if (track.kind === 'video' && !isScreenShare) {
                    renderVideo(track, container);
                }
                // Audio Logic: Play everything (Mic + YouTube audio etc)
                if (track.kind === 'audio') {
                    playAudio(track);
                }
            }

            // --- MODE: SCREEN (Window 2) ---
            // Shows: Screen Share Video
            // Plays: NOTHING (Silence to prevent echo)
            else if (MODE === 'screen') {
                if (track.kind === 'video' && isScreenShare) {
                    renderVideo(track, container);
                }
                // Audio is ignored entirely here
            }
        });

        call.on('track-stopped', () => {
            // When track stops, clear container so Background Graphic reappears
            document.getElementById('call-container').innerHTML = '';
        });

        // --- 4. HELPERS ---
        function renderVideo(track, container) {
            container.innerHTML = ''; // Ensure clean slate
            const videoEl = document.createElement('video');
            videoEl.srcObject = new MediaStream([track]);
            videoEl.autoplay = true;
            videoEl.muted = true; // Video tracks muted (Audio handled separately if needed)
            videoEl.playsInline = true;
            container.appendChild(videoEl);
        }

        function playAudio(track) {
            const audioEl = document.createElement('audio');
            audioEl.srcObject = new MediaStream([track]);
            audioEl.autoplay = true;
            document.body.appendChild(audioEl);
        }

        // --- 5. INITIALIZATION & IPAD LOGIC ---
        async function start() {
            try {
                // IPAD MODE
                if (MODE === 'ipad') {
                    document.getElementById('ipad-ui').style.display = 'block';
                    await call.join({ url: ROOM_URL, audioSource: false, videoSource: false });
                    
                    document.getElementById('shareBtn').onclick = async () => {
                        await call.startScreenShare({ displaySurface: 'window' }); // Select Reflector
                        document.getElementById('ipad-ui').style.display = 'none';
                    };
                } 
                // VIEWER MODES
                else {
                    await call.join({ url: ROOM_URL, audioSource: false, videoSource: false });
                    // Subscribe to everything; 'track-started' will decide what to render
                    call.updateParticipant('*', { setSubscribedTracks: true });
                }
            } catch (err) {
                console.error("Join failed", err);
            }
        }

        start();
    </script>
</body>
</html>
