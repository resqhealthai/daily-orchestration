<!DOCTYPE html>
<html>
<head>
    <title>ResQ Smart Viewer</title>
    <meta charset="utf-8">
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #000; overflow: hidden; }
        #debug {
            position: fixed; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.8);
            padding: 10px; font-family: monospace; font-size: 16px; z-index: 20000; pointer-events: none; border: 1px solid #0f0;
        }
    </style>
    <!-- Use the Official API CDN (Confirmed Working) -->
    <script crossorigin src="https://api.daily.co/daily.js"></script>
</head>
<body>
    <div id="debug">Initializing...</div>
    
    <script>
        let callFrame = null;
        let loopCount = 0;
        let joinStatus = "Waiting for SDK...";

        // 1. SDK CHECK
        const sdkCheck = setInterval(() => {
            if (window.DailyIframe) {
                clearInterval(sdkCheck);
                init();
            }
        }, 500);

        // 2. MAIN INIT
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const roomUrl = params.get('roomUrl');
            const mode = params.get('mode') || 'face';

            if (!roomUrl) { joinStatus = "Error: No roomUrl"; updateDebug(); return; }

            // Create Frame
            callFrame = window.DailyIframe.createFrame(document.body, {
                showLeaveButton: false,
                showFullscreenButton: false,
                showUserName: false,
                iframeStyle: {
                    position: 'fixed', top: '0', left: '0', width: '100%', height: '100%', border: '0', zIndex: '1'
                }
            });

            joinStatus = "Joining...";
            updateDebug();

            try {
                await callFrame.join({ 
                    url: roomUrl,
                    showLocalVideo: false,
                    startVideoOff: true,
                    startAudioOff: false,
                    userName: `Display-${mode.toUpperCase()}`,
                    
                    // CONFIGURATION:
                    subscribeToTracksAutomatically: true, // FAST CONNECT
                    activeSpeakerMode: false // GRID MODE (Allows separate styles)
                });
                joinStatus = "Joined.";
            } catch(e) {
                joinStatus = `Error: ${e.message}`;
            }
        }

        // 3. STYLE ENFORCEMENT LOOP
        setInterval(() => {
            loopCount++;
            
            if (callFrame) {
                const mode = new URLSearchParams(window.location.search).get('mode') || 'face';
                const participants = callFrame.participants();
                
                for (const id in participants) {
                    const p = participants[id];
                    if (p.local) continue; // Skip self

                    // === THE MAGIC FIX ===
                    // Instead of unsubscribing (which errors), we use the 'styles' API
                    // to set the specific video track to 'display: none'.
                    
                    if (mode === 'face') {
                        // FACE MODE:
                        // Cam -> Full Screen
                        // Screen -> Hidden
                        callFrame.updateParticipant(id, {
                            styles: {
                                cam: { 
                                    width: '100vw', height: '100vh', 
                                    display: 'block', 
                                    video: { objectFit: 'cover' } 
                                },
                                screen: { display: 'none' }
                            }
                        });
                    } else if (mode === 'screen') {
                        // SCREEN MODE:
                        // Cam -> Hidden
                        // Screen -> Full Screen
                        callFrame.updateParticipant(id, {
                            styles: {
                                cam: { display: 'none' },
                                screen: { 
                                    width: '100vw', height: '100vh', 
                                    display: 'block',
                                    video: { objectFit: 'contain' } // Keep aspect ratio for text
                                }
                            }
                        });
                    }
                }
            }
            updateDebug();
        }, 1000);

        function updateDebug() {
            const d = document.getElementById('debug');
            if (d) d.innerText = `Loop: ${loopCount}\nStatus: ${joinStatus}`;
        }
    </script>
</body>
</html>
