<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVCH V11.1 - Debug UI</title>
    <style>
        body { 
            background: #000; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-family: sans-serif;
            color: white;
        }

        /* DEFAULT GRAPHIC (INITIALIZING) */
        #placeholder {
            z-index: 5;
            text-align: center;
        }
        .icon { font-size: 80px; display: block; margin-bottom: 10px; }
        .text { font-size: 24px; letter-spacing: 2px; text-transform: uppercase; }
        .subtext { font-size: 14px; color: #888; margin-top: 10px; }
        .error-msg { color: #FF4136; font-family: monospace; background: #333; padding: 10px; margin-top: 20px; border-radius: 5px; }

        /* MODE COLORS */
        body.mode-face #placeholder   { color: #7FDBFF; }
        body.mode-screen #placeholder { color: #2ECC40; }
        body.mode-tablet #placeholder { color: #FF4136; }

        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; z-index: 10; background: black; 
        }
    </style>
</head>
<body>

    <div id="placeholder">
        <span id="icon" class="icon">‚ö†Ô∏è</span>
        <div id="status-text" class="text">INITIALIZING...</div>
        <div id="sub-text" class="subtext">V11.1 Loading Script</div>
        <div id="error-box" class="error-msg" style="display:none;"></div>
    </div>

    <div id="container"></div>

    <script>
        // === 1. CRASH CATCHER (Must be first) ===
        window.onerror = function(msg, source, lineno) {
            const box = document.getElementById('error-box');
            box.style.display = 'block';
            box.innerText = "JS CRASH: " + msg + " (Line " + lineno + ")";
            document.getElementById('status-text').innerText = "SYSTEM FAILURE";
        };

        // === 2. CONFIGURATION ===
        const params = new URLSearchParams(window.location.search);
        const MODE = params.get('mode');
        const NAME = params.get('name');
        const URL = params.get('url');

        // Apply Mode Class
        if (MODE) document.body.classList.add('mode-' + MODE);

        // UI Elements
        const icon = document.getElementById('icon');
        const txt = document.getElementById('status-text');
        const sub = document.getElementById('sub-text');
        const ph = document.getElementById('placeholder');

        // === 3. UPDATE UI (Initial State) ===
        function setUI() {
            if (MODE === 'face') {
                icon.innerText = "üë§";
                txt.innerText = "WAITING FOR INSTRUCTOR";
                sub.innerText = "Monitor 1";
            } else if (MODE === 'screen') {
                icon.innerText = "üñ•Ô∏è";
                txt.innerText = "WAITING FOR SCREEN SHARE";
                sub.innerText = "Monitor 2";
            } else if (MODE === 'tablet') {
                icon.innerText = "üì°";
                txt.innerText = "TABLET UPLINK ACTIVE";
                sub.innerText = "Sending Video...";
            }
        }
        setUI(); // Run immediately

        // === 4. LOAD LIBRARY ===
        function loadLib() {
            const script = document.createElement('script');
            script.src = "https://unpkg.com/@daily-co/daily-js";
            script.async = true;
            script.onload = () => runApp();
            script.onerror = () => { txt.innerText = "NETWORK ERROR"; sub.innerText = "Blocked by Firewall?"; };
            document.head.appendChild(script);
        }

        // === 5. MAIN APP ===
        async function runApp() {
            try {
                if (!URL) throw new Error("Missing Room URL");

                // Tablet Delay
                if (MODE === 'tablet') {
                    sub.innerText = "Yielding to Face Cam (8s)...";
                    await new Promise(function(resolve) { setTimeout(resolve, 8000); });
                    sub.innerText = "Connecting...";
                }

                const call = window.DailyIframe.createCallObject({
                    dailyConfig: { experimentalChromeVideoMuteLightOff: true }
                });

                // TRACK STARTED
                call.on('track-started', function(e) {
                    if (e.track.kind !== 'video') return;
                    const p = e.participant;
                    
                    let show = false;
                    if (MODE === 'face' && !p.local && !p.screen && !p.user_name.includes("Tablet")) show = true;
                    if (MODE === 'screen' && !p.local && p.screen) show = true;
                    if (MODE === 'tablet' && p.local) show = true;

                    if (show) {
                        displayVideo(e.track);
                    }
                });

                // TRACK STOPPED
                call.on('track-stopped', function(e) {
                    setTimeout(function() {
                        const v = document.querySelector('video');
                        if (v && v.srcObject && v.srcObject.getVideoTracks()[0].readyState === 'ended') {
                            clearVideo();
                        }
                    }, 500);
                });

                // DEVICE SELECTION
                let vid = false;
                let aud = false;

                if (MODE !== 'screen') {
                    try {
                        await navigator.mediaDevices.getUserMedia({ video: true });
                        const devs = await navigator.mediaDevices.enumerateDevices();
                        const vDevs = devs.filter(function(d) { return d.kind === 'videoinput'; });
                        
                        const keyword = (MODE === 'face') ? "Logitech" : "OBS";
                        const target = vDevs.find(function(d) { return d.label.includes(keyword); });

                        if (target) {
                            vid = target.deviceId;
                            aud = (MODE === 'face');
                        } else {
                            vid = true; // Fallback
                        }
                    } catch(e) { console.log(e); }
                }

                await call.join({ url: URL, userName: NAME, videoSource: vid, audioSource: aud });
                
                if (MODE === 'tablet' && vid) call.setLocalVideo(true);

            } catch(e) {
                txt.innerText = "APP CRASH";
                sub.innerText = e.message;
            }
        }

        // HELPERS
        function displayVideo(track) {
            const c = document.getElementById('container');
            c.innerHTML = '';
            const el = document.createElement('video');
            el.srcObject = new MediaStream([track]);
            el.autoplay = true; el.muted = true;
            c.appendChild(el);
            ph.style.opacity = '0';
        }

        function clearVideo() {
            document.getElementById('container').innerHTML = '';
            ph.style.opacity = '1';
        }

        // START
        loadLib();

    </script>
</body>
</html>
