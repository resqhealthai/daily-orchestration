<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVCH Orchestrator V5.0</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        /* --- 1. VISUALS & GRAPHIC --- */
        body { 
            margin: 0; padding: 0; 
            overflow: hidden; 
            height: 100vh; 
            background-color: #000;
            display: flex; 
            justify-content: center; 
            align-items: center;

            /* The Standby Graphic (Visible when no video is playing) */
            background-image: url('https://placehold.co/1920x1080/222222/FFFFFF?text=ResQ+Health+Training+Center'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
        }

        /* --- 2. VIDEO LAYOUT --- */
        /* Z-Index 10 ensures video covers the graphic when active */
        video { 
            width: 100%; height: 100%; 
            object-fit: contain; 
            position: absolute; 
            z-index: 10; 
            background: #000; 
        }

        /* --- 3. UI FOR IPAD / PERMISSIONS --- */
        /* Only visible if we need to click something (Window 3 only) */
        #ui-layer {
            z-index: 20;
            position: relative;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        button { font-size: 18px; padding: 10px 20px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="call-container"></div>
    
    <div id="ui-layer">
        <h2 id="status-text">Initializing...</h2>
        <button id="action-btn" style="display:none">Action</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const ROOM_URL = params.get('url'); 
        const MODE = params.get('mode'); // 'face', 'screen', or 'ipad'

        // --- 1. CONFIGURE THE LOCAL MAC MINI ---
        // We configure the hardware access based on which Window we are in.
        let callOptions = {
            url: ROOM_URL,
            subscribeToTracksAutomatically: false, // Manual control
            dailyConfig: { experimentalChromeVideoMuteLightOff: true }
        };

        if (MODE === 'face') {
            // WINDOW 1: Behaves as the "Room Host"
            // Enable Mic & Cam so the Instructor can see/hear the classroom immediately
            callOptions.audioSource = true; 
            callOptions.videoSource = true;
        } else if (MODE === 'ipad') {
            // WINDOW 3: iPad Uplink
            // No Mic/Cam, we only want to Screen Share
            callOptions.audioSource = false;
            callOptions.videoSource = false;
        } else {
            // WINDOW 2: Passive Screen Viewer
            callOptions.audioSource = false;
            callOptions.videoSource = false;
        }

        const call = window.DailyIframe.createCallObject(callOptions);

        // --- 2. LOGIC FOR DISPLAYING REMOTE VIDEO ---
        call.on('track-started', (e) => {
            const p = e.participant;
            const track = e.track;

            // SAFETY: Don't show our own cameras or the iPad loopback
            // This ensures Window 1 and 2 don't show the iPad screen
            if (p.local) return; 
            if ((p.user_name || "").includes("MacMini")) return; 

            const isScreenShare = p.screen;
            const container = document.getElementById('call-container');

            // --- MONITOR 1 LOGIC (Face) ---
            if (MODE === 'face') {
                // Show Video IF: It is a Camera (not a screen share)
                if (track.kind === 'video' && !isScreenShare) {
                    renderVideo(track, container);
                }
                // Play Audio IF: It is any audio (Instructor Mic or their PC Sound)
                if (track.kind === 'audio') {
                    playAudio(track);
                }
            }

            // --- MONITOR 2 LOGIC (Screen) ---
            else if (MODE === 'screen') {
                // Show Video IF: It IS a screen share
                if (track.kind === 'video' && isScreenShare) {
                    renderVideo(track, container);
                }
            }
        });

        // --- 3. HANDLE INSTRUCTOR TURNING OFF CAM/SCREEN ---
        call.on('track-stopped', (e) => {
             // If the track stops, we clear the container.
             // This reveals the underlying 'background-image' (The Standby Graphic)
             if (!e.participant.local) {
                 document.getElementById('call-container').innerHTML = '';
             }
        });

        // --- 4. STARTUP & PERMISSION HANDLING ---
        async function start() {
            const ui = document.getElementById('ui-layer');
            const btn = document.getElementById('action-btn');
            const status = document.getElementById('status-text');

            if (!ROOM_URL) {
                status.innerText = "ERR: No URL Provided";
                ui.style.display = 'block';
                return;
            }

            try {
                // WINDOW 3: iPad Auto-Setup
                if (MODE === 'ipad') {
                    ui.style.display = 'block';
                    status.innerText = "iPad Uplink Mode";
                    // Join as MacMini-iPad so other windows know to ignore this feed
                    await call.join({ userName: 'MacMini-iPad' });
                    
                    // Setup button to trigger the Reflector share
                    btn.innerText = "Select Reflector Window";
                    btn.style.display = 'inline-block';
                    btn.onclick = async () => {
                        try {
                            await call.startScreenShare({ displaySurface: 'window' });
                            ui.style.display = 'none'; // Hide UI after success
                        } catch (err) {
                            status.innerText = "Share Failed: " + err.message;
                        }
                    };
                } 
                
                // WINDOW 1: Camera/Mic Setup (Always On)
                else if (MODE === 'face') {
                    // Browser will prompt for permissions here once
                    await call.join({ userName: 'MacMini-Classroom' });
                }

                // WINDOW 2: Passive
                else {
                    await call.join({ userName: 'MacMini-ScreenDisp' });
                    // Subscribe to everything so we can catch the 'track-started' events
                    call.updateParticipant('*', { setSubscribedTracks: true });
                }

            } catch (err) {
                ui.style.display = 'block';
                status.innerText = "Error: " + err.message;
            }
        }

        // --- HELPERS ---
        function renderVideo(track, container) {
            container.innerHTML = ''; 
            const videoEl = document.createElement('video');
            videoEl.srcObject = new MediaStream([track]);
            videoEl.autoplay = true;
            videoEl.muted = true; // Video tracks muted (Audio handled separately)
            videoEl.playsInline = true;
            container.appendChild(videoEl);
        }

        function playAudio(track) {
            // Create invisible audio element
            const audioEl = document.createElement('audio');
            audioEl.srcObject = new MediaStream([track]);
            audioEl.autoplay = true;
            document.body.appendChild(audioEl);
        }

        start();
    </script>
</body>
</html>
