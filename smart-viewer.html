<!DOCTYPE html>
<html>
<head>
    <title>ResQ Smart Viewer</title>
    <meta charset="utf-8">
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #000; overflow: hidden; }
        #debug {
            position: fixed; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.8);
            padding: 10px; font-family: monospace; font-size: 16px; z-index: 10000; pointer-events: none; border: 1px solid #0f0;
        }
    </style>
    
    <!-- SWITCHING BACK TO UNPKG (This worked for you before) -->
    <script crossorigin src="https://unpkg.com/@daily-co/daily-js"></script>
    
</head>
<body>
    <div id="debug">Initializing Script...</div>
    
    <script>
        let callFrame = null;
        let loopCount = 0;
        let joinStatus = "Waiting for SDK...";
        let retryCount = 0;

        // 1. SDK LOADER LOOP
        // We check every 500ms to see if Daily has loaded
        const sdkCheck = setInterval(() => {
            if (window.DailyIframe) {
                clearInterval(sdkCheck);
                joinStatus = "SDK Loaded. Starting Init...";
                init();
            } else {
                retryCount++;
                joinStatus = `Waiting for SDK... (${retryCount})`;
                if (retryCount > 20) {
                    joinStatus = "CRITICAL ERROR: SDK Failed to Load (unpkg.com)";
                }
            }
            // Update debug text immediately
            updateDebug();
        }, 500);

        function updateDebug() {
            const d = document.getElementById('debug');
            if (!d) return;
            const mode = new URLSearchParams(window.location.search).get('mode') || 'unknown';
            
            let statusText = `Loop: ${loopCount}\nMode: ${mode}\nStatus: ${joinStatus}`;
            
            if (callFrame) {
                try {
                    const participants = callFrame.participants();
                    const pList = Object.values(participants);
                    const remote = pList.filter(p => !p.local);
                    statusText += `\nRemote Users: ${remote.length}`;
                    
                    remote.forEach(p => {
                        statusText += `\n[${p.user_name}] Cam:${p.video} Screen:${p.screen}`;
                        
                        // LOGIC APPLICATION
                        if (mode === 'face') {
                            callFrame.updateParticipant(p.session_id, {
                                setSubscribedTracks: { audio: true, video: true, screenVideo: false }
                            });
                        } else if (mode === 'screen') {
                            callFrame.updateParticipant(p.session_id, {
                                setSubscribedTracks: { audio: true, video: false, screenVideo: true }
                            });
                        }
                    });
                } catch (e) { statusText += `\nErr: ${e.message}`; }
            }
            d.innerText = statusText;
        }

        // 2. LOGIC LOOP
        setInterval(() => {
            loopCount++;
            updateDebug();
        }, 1000);

        // 3. MAIN INIT
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const roomUrl = params.get('roomUrl');
            const mode = params.get('mode') || 'face';

            if (!roomUrl) { joinStatus = "Error: No roomUrl"; return; }

            // Create Frame
            callFrame = window.DailyIframe.createFrame(document.body, {
                showLeaveButton: false,
                showFullscreenButton: false,
                showUserName: false,
                iframeStyle: {
                    position: 'fixed', top: '0', left: '0', width: '100%', height: '100%', border: '0', zIndex: '1'
                }
            });

            // Join
            joinStatus = "Joining Room...";
            try {
                await callFrame.join({ 
                    url: roomUrl,
                    showLocalVideo: false,
                    startVideoOff: true,
                    startAudioOff: false,
                    userName: `Display-${mode.toUpperCase()}`,
                    activeSpeakerMode: true,
                    layoutConfig: {
                        mode: "active-speaker",
                        showParticipantsBar: false
                    }
                });
                joinStatus = "Joined & Active";
            } catch(e) {
                joinStatus = `Join Failed: ${e.message}`;
                console.error(e);
            }
        }
    </script>
</body>
</html>
