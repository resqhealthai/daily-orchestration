<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Viewer v16.1</title>
    <style>
        body { 
            background: #000; margin: 0; overflow: hidden; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: sans-serif; color: white;
        }

        /* --- STANDBY GRAPHIC --- */
        #standby {
            text-align: center; z-index: 20; transition: opacity 0.5s ease; width: 80%;
        }
        .logo { font-size: 80px; margin-bottom: 30px; display: block; }
        .status-text {
            font-size: 32px; font-weight: 300; letter-spacing: 1px; color: #ccc;
            line-height: 1.5; text-transform: uppercase;
        }
        .pulse { animation: pulse-animation 2s infinite ease-in-out; }
        @keyframes pulse-animation { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- RETRY BUTTON --- */
        #retry-btn {
            display: none; margin-top: 20px; padding: 15px 30px;
            font-size: 20px; background: #FF4136; color: white; 
            border: none; border-radius: 8px; cursor: pointer; z-index: 50;
        }

        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; z-index: 10; background: black; 
        }
    </style>
</head>
<body>

    <div id="standby">
        <div class="logo">⚕️</div> 
        <div id="status" class="status-text pulse">Loading...</div>
        <button id="retry-btn" onclick="enableCamera()">⚠️ ENABLE CAMERA UPLINK</button>
    </div>

    <div id="container"></div>

    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <script>
        var params = new URLSearchParams(window.location.search);
        var MODE = params.get('mode');
        var targetURL = params.get('url') ? params.get('url').trim().replace(/"/g, '') : "";
        var NAME = params.get('name') || "Smart-Viewer";
        
        var stat = document.getElementById('status');
        var standby = document.getElementById('standby');
        var container = document.getElementById('container');
        var retryBtn = document.getElementById('retry-btn');
        var call = null;
        var currentTrackId = null;

        // 1. SET CUSTOM MESSAGES
        var customMsg = "Initializing...";
        if (MODE === 'face') customMsg = "Awaiting instructor's camera and microphone";
        if (MODE === 'screen') customMsg = "Awaiting instructor's screen share";
        if (MODE === 'tablet') customMsg = "Connecting Tablet Uplink...";
        stat.innerText = customMsg;

        if (!targetURL) { stat.innerText = "CONFIG ERROR: NO URL"; stat.style.color = "red"; }
        else { init(); }

        async function init() {
            try {
                call = window.DailyIframe.createCallObject({
                    dailyConfig: { experimentalChromeVideoMuteLightOff: true }
                });

                call.on('track-started', handleVideoStart);
                call.on('track-stopped', handleVideoStop);
                call.on('error', (e) => { stat.innerText = "ERR: " + (e.errorMsg || e); });

                // 2. JOIN ATTEMPT (FAIL-SAFE)
                let isSender = (MODE === 'tablet' || MODE === 'face');
                try {
                    await call.join({ url: targetURL, userName: NAME, audioSource: isSender, videoSource: isSender });
                } catch (joinError) {
                    console.error("Primary Join Failed", joinError);
                    stat.innerText = "CAMERA BLOCKED. RETRYING PASSIVE...";
                    await call.join({ url: targetURL, userName: NAME, audioSource: false, videoSource: false });
                    // SHOW THE RED BUTTON if we failed to get camera access
                    if (isSender) retryBtn.style.display = "inline-block";
                }

            } catch(e) { stat.innerText = "CRASH: " + e.message; }
        }

        // --- MANUAL TRIGGER ---
        function enableCamera() {
            if (call) {
                retryBtn.innerText = "ACTIVATING...";
                call.setLocalVideo(true).then(() => retryBtn.style.display = 'none');
            }
        }

        // --- TRACK HANDLING ---
        function handleVideoStart(e) {
            // Check if this track matches our mode
            if (!shouldProcess(e)) return;

            standby.style.display = 'none';
            container.innerHTML = ''; 
            var el = document.createElement('video');
            el.srcObject = new MediaStream([e.track]);
            el.autoplay = true; el.muted = true;
            container.appendChild(el);
            currentTrackId = e.track.id;
        }

        function handleVideoStop(e) {
            if (e.track.id === currentTrackId) {
                standby.style.display = 'block';
                container.innerHTML = '';
                currentTrackId = null;
            }
        }

        // --- THE "ID MATCH" LOGIC (V16.1) ---
        function shouldProcess(event) {
            var p = event.participant;
            var track = event.track;

            // 1. GLOBAL: Ignore Local (unless Tablet loopback)
            if (p.local && MODE !== 'tablet') return false;

            // 2. FIND TRACK TYPE BY CHECKING ID
            // We look at the participant's track list to see where this ID lives
            var isScreen = false;
            var isCam = false;

            // Check if this is the Screen Track
            if (p.tracks.screenVideo && 
                p.tracks.screenVideo.persistentTrack && 
                p.tracks.screenVideo.persistentTrack.id === track.id) {
                isScreen = true;
            }

            // Check if this is the Camera Track
            if (p.tracks.video && 
                p.tracks.video.persistentTrack && 
                p.tracks.video.persistentTrack.id === track.id) {
                isCam = true;
            }

            // 3. ROUTING
            if (MODE === 'face') {
                return isCam; // ONLY allow confirmed Camera tracks
            } 
            else if (MODE === 'screen') {
                return isScreen; // ONLY allow confirmed Screen tracks
            }
            else if (MODE === 'tablet') {
                return isCam && !p.local;
            }
            
            return false;
        }
    </script>
</body>
</html>
