<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVCH Smart Viewer</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; }
        #call-container { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="call-container"></div>

    <script>
        async function startOrchestrator() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomUrl = urlParams.get('url');
            const mode = urlParams.get('mode'); // 'face', 'screen', or 'ipad'

            if (!roomUrl) {
                console.error("No room URL provided.");
                return;
            }

            // 1. Initialize Call Object
            const callObject = window.DailyIframe.createCallObject({
                subscribeToAll: mode !== 'ipad', // COST SAVING: iPad mode doesn't download other feeds
            });

            // 2. Configure Join Options based on Mode
            let joinOptions = { url: roomUrl };

            if (mode === 'ipad') {
                // IPAD MODE: No mic, no camera, just screen capture
                joinOptions.audioSource = false;
                joinOptions.videoSource = false;
            } else if (mode === 'screen') {
                // SCREEN MODE: Typically just receives instructor feed
                joinOptions.audioSource = false;
                joinOptions.videoSource = false;
            }

            // 3. Handle Automated Screen Sharing for iPad Mode
            callObject.on('joined-meeting', async () => {
                console.log(`Joined in ${mode} mode.`);
                
                if (mode === 'ipad') {
                    try {
                        // Automatically trigger screen share for the Reflector window
                        // Note: Safari policy may require a user gesture or specific profile via Hexnode
                        await callObject.startScreenShare({
                            displaySurface: 'window',
                            systemAudio: 'exclude'
                        });
                        console.log("iPad screen share initiated.");
                    } catch (e) {
                        console.error("Screen share failed:", e);
                    }
                }
            });

            // 4. Join the Room
            try {
                await callObject.join(joinOptions);
                
                // Embed the video in the container
                const container = document.getElementById('call-container');
                const iframe = callObject.iframe();
                if (iframe) {
                    container.appendChild(iframe);
                }
            } catch (e) {
                console.error("Join failed:", e);
            }
        }

        startOrchestrator();
    </script>
</body>
</html>
