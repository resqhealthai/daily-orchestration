<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResQ Smart Viewer</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        /* 1. LAYOUT & BACKGROUND */
        body { 
            margin: 0; padding: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background-color: #121212;
            
            /* CUSTOM GRAPHIC URL */
            background-image: url('https://placehold.co/1920x1080/222222/FFFFFF?text=ResQ+Health+Training+Center'); 
            
            background-size: cover; 
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 2. VIDEO ELEMENT */
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            position: absolute; 
            top: 0; left: 0; 
            z-index: 1; 
            background: transparent;
            transition: opacity 0.5s ease; /* Smooth fade in/out */
        }

        /* Class to hide video (reveal background) */
        .hidden { opacity: 0; }
    </style>
</head>
<body>
    <!-- Video starts hidden so background shows -->
    <video id="videoEl" class="hidden" autoplay playsinline></video>
    <audio id="audioEl" autoplay></audio>

    <script>
        const log = (msg) => console.log(`[SmartViewer] ${msg}`);

        // 1. PARAMS
        const params = new URLSearchParams(window.location.search);
        const ROOM_URL = params.get('roomUrl') || params.get('url'); 
        const MODE = params.get('mode') || 'face';

        if (!ROOM_URL) throw new Error("Missing Room URL");

        // 2. CONFIG
        const isPassiveMode = (MODE === 'screen');
        const call = window.DailyIframe.createCallObject({
            userName: `MacMini-${MODE}`,
            subscribeToTracksAutomatically: false, 
            videoSource: !isPassiveMode, 
            audioSource: !isPassiveMode,
            dailyConfig: { experimentalChromeVideoMuteLightOff: true }
        });

        const videoEl = document.getElementById('videoEl');
        const audioEl = document.getElementById('audioEl');

        // 3. LOGIC: IGNORE KIOSKS & TABLETS
        const checkParticipant = (p) => {
            if (p.local) return { ignore: true };
            const name = (p.user_name || "Guest").toLowerCase();
            if (name.includes("macmini")) return { ignore: true };
            if (name.includes("tablet")) return { ignore: true };
            if (name.includes("android")) return { ignore: true };
            return { ignore: false, name: p.user_name || "Guest" };
        };

        // 4. SUBSCRIPTION LOGIC
        const handleNewParticipant = (p) => {
            const check = checkParticipant(p);
            if (check.ignore) return;

            log(`Accepted Instructor: ${check.name}`);

            let subs = { audio: false, video: false, screenVideo: false };
            if (MODE === 'face') {
                subs = { audio: true, video: true, screenVideo: false };
            } else if (MODE === 'screen') {
                subs = { audio: false, video: false, screenVideo: true };
            }

            call.updateParticipant(p.session_id, { setSubscribedTracks: subs });
        };

        // 5. RENDER LOGIC
        const handleTrack = (evt) => {
            const track = evt.track;
            const p = evt.participant;
            if (!track || !p) return;
            if (checkParticipant(p).ignore) return;

            // Mode Check
            const isScreenShare = p.screen; 
            if (MODE === 'face') {
                if (track.kind === 'video' && isScreenShare) return;
            } else if (MODE === 'screen') {
                if (track.kind === 'video' && !isScreenShare) return;
            }

            log(`Playing ${track.kind}`);
            const targetEl = track.kind === 'video' ? videoEl : audioEl;
            
            if (targetEl.srcObject?.id !== track.id) {
                targetEl.srcObject = new MediaStream([track]);
                
                // Show Video (Fade In)
                if (track.kind === 'video') {
                    videoEl.classList.remove('hidden');
                }

                const forcePlay = () => {
                    targetEl.play().catch(e => {
                        log("Autoplay blocked, retrying...");
                        setTimeout(forcePlay, 1000);
                    });
                };
                forcePlay();
            }
        };

        // 6. TRACK STOPPED (Show Background)
        const handleTrackStopped = (evt) => {
            const track = evt.track;
            if (!track) return;
            
            if (track.kind === 'video') {
                log("Video Stopped. Showing Background.");
                // If this was the active track, hide the video element
                if (videoEl.srcObject && videoEl.srcObject.getTracks().some(t => t.id === track.id)) {
                    videoEl.srcObject = null;
                    videoEl.classList.add('hidden'); 
                }
            }
        };

        // 7. EVENT LISTENERS
        call.on('participant-joined', (evt) => handleNewParticipant(evt.participant));
        call.on('participant-updated', (evt) => handleNewParticipant(evt.participant));
        call.on('track-started', handleTrack);
        call.on('track-stopped', handleTrackStopped); 

        call.on('joined-meeting', (evt) => {
            log("Joined. Scanning...");
            const participants = call.participants();
            const remotes = Object.values(participants).filter(p => !p.local);
            if(remotes.length > 0) {
                remotes.forEach(p => handleNewParticipant(p));
            }
        });

        call.join({ url: ROOM_URL });
    </script>
</body>
</html>
