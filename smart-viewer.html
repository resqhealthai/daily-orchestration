<!DOCTYPE html>
<html>
<head>
    <title>ResQ Smart Viewer</title>
    <meta charset="utf-8">
    <style>
        /* 1. FORCE IFRAME CONTAINER FULL SCREEN */
        html, body { 
            width: 100%; height: 100%; margin: 0; padding: 0; 
            background: #000; overflow: hidden; 
        }
        
        /* 2. FORCE VIDEO TILES FULL SCREEN (The "Stacking" Trick) */
        /* This forces every video tile to try and fill the screen. */
        /* We will use z-index in JS to decide which one wins. */
        .daily-video-div {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }

        #debug {
            position: fixed; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.8);
            padding: 10px; font-family: monospace; font-size: 16px; z-index: 20000; pointer-events: none; border: 1px solid #0f0;
        }
    </style>
    <script crossorigin src="https://unpkg.com/@daily-co/daily-js"></script>
</head>
<body>
    <div id="debug">Initializing...</div>
    
    <script>
        let callFrame = null;
        let loopCount = 0;
        let joinStatus = "Waiting for SDK...";

        // 1. SDK CHECK
        const sdkCheck = setInterval(() => {
            if (window.DailyIframe) {
                clearInterval(sdkCheck);
                init();
            }
        }, 500);

        // 2. MAIN INIT
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const roomUrl = params.get('roomUrl');
            const mode = params.get('mode') || 'face';

            if (!roomUrl) { joinStatus = "Error: No roomUrl"; updateDebug(); return; }

            // Create Frame
            callFrame = window.DailyIframe.createFrame(document.body, {
                showLeaveButton: false,
                showFullscreenButton: false,
                showUserName: false,
                iframeStyle: {
                    position: 'fixed', top: '0', left: '0', width: '100%', height: '100%', border: '0', zIndex: '1'
                }
            });

            joinStatus = "Joining...";
            updateDebug();

            try {
                await callFrame.join({ 
                    url: roomUrl,
                    showLocalVideo: false,
                    startVideoOff: true,
                    startAudioOff: false,
                    userName: `Display-${mode.toUpperCase()}`,
                    
                    // KEY CONFIGURATION:
                    subscribeToTracksAutomatically: true, // 1. Get Video Fast (Fixes Black Screen)
                    activeSpeakerMode: false // 2. Grid Mode (Renders ALL videos to DOM)
                });
                joinStatus = "Joined.";
            } catch(e) {
                joinStatus = `Error: ${e.message}`;
            }
        }

        // 3. VISUAL STACKING LOOP
        setInterval(() => {
            loopCount++;
            updateDebug();
            
            // This loop looks at the actual HTML video elements Daily created
            // and forces the right one to the top (z-index).
            const mode = new URLSearchParams(window.location.search).get('mode') || 'face';
            
            // Find all video containers
            // Daily uses classes like "daily-video-div" and specific data attributes
            const videos = document.querySelectorAll('.daily-video-div');
            
            videos.forEach(div => {
                // Identify what kind of video this is
                // Daily usually marks screen shares with a class or data attribute
                // If specific class isn't stable, we check the video element inside?
                // Let's rely on Daily's standard class: 'daily-screen-share'
                
                const isScreen = div.classList.contains('daily-screen-share');
                const isLocal = div.classList.contains('local'); // Hide self
                
                if (isLocal) {
                    div.style.display = 'none';
                    return;
                }

                if (mode === 'face') {
                    // FACE MODE:
                    // Camera (Not Screen) -> Z-Index 100 (Top)
                    // Screen -> Display None
                    if (isScreen) {
                        div.style.display = 'none';
                    } else {
                        div.style.display = 'block';
                        div.style.zIndex = '100';
                    }
                } else if (mode === 'screen') {
                    // SCREEN MODE:
                    // Screen -> Z-Index 100 (Top)
                    // Camera -> Display None
                    if (isScreen) {
                        div.style.display = 'block';
                        div.style.zIndex = '100';
                    } else {
                        div.style.display = 'none';
                    }
                }
            });

        }, 500);

        function updateDebug() {
            const d = document.getElementById('debug');
            if (d) d.innerText = `Loop: ${loopCount}\nStatus: ${joinStatus}`;
        }
    </script>
</body>
</html>
