<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Viewer v17.0</title>
    <style>
        body { 
            background: #000; margin: 0; overflow: hidden; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: sans-serif; color: white;
        }

        /* --- STANDBY GRAPHIC --- */
        #standby {
            text-align: center; z-index: 20; transition: opacity 0.5s ease; width: 80%;
        }
        .logo { font-size: 80px; margin-bottom: 30px; display: block; }
        .status-text {
            font-size: 32px; font-weight: 300; letter-spacing: 1px; color: #ccc;
            line-height: 1.5; text-transform: uppercase;
        }
        .pulse { animation: pulse-animation 2s infinite ease-in-out; }
        @keyframes pulse-animation { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- RETRY BUTTON --- */
        #retry-btn {
            display: none; margin-top: 20px; padding: 15px 30px;
            font-size: 20px; background: #FF4136; color: white; 
            border: none; border-radius: 8px; cursor: pointer; z-index: 50;
        }

        /* --- CRASH LOG (Visible only if error) --- */
        #crash-log {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: rgba(50, 0, 0, 0.9); color: #ffcccc; 
            font-family: monospace; font-size: 14px; padding: 10px;
            display: none; z-index: 1000;
        }

        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; z-index: 10; background: black; 
        }
    </style>
</head>
<body>

    <div id="crash-log"></div>

    <div id="standby">
        <div class="logo">⚕️</div> 
        <div id="status" class="status-text pulse">Loading System...</div>
        <button id="retry-btn" onclick="enableCamera()">⚠️ ENABLE CAMERA UPLINK</button>
    </div>

    <div id="container"></div>

    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <script>
        // GLOBAL ERROR HANDLER (Catches Syntax Errors)
        window.onerror = function(message, source, lineno, colno, error) {
            var log = document.getElementById('crash-log');
            log.style.display = 'block';
            log.innerText = "SYSTEM ERROR: " + message + " at line " + lineno;
        };

        var params = new URLSearchParams(window.location.search);
        var MODE = params.get('mode');
        var targetURL = params.get('url') ? params.get('url').trim().replace(/"/g, '') : "";
        var NAME = params.get('name') || "Smart-Viewer";
        
        var stat = document.getElementById('status');
        var standby = document.getElementById('standby');
        var container = document.getElementById('container');
        var retryBtn = document.getElementById('retry-btn');
        var call = null;
        var currentTrackId = null;

        // 1. SET CUSTOM MESSAGES
        var customMsg = "Initializing...";
        if (MODE === 'face') customMsg = "Awaiting instructor's camera";
        if (MODE === 'screen') customMsg = "Awaiting instructor's screen share";
        if (MODE === 'tablet') customMsg = "Connecting Tablet Uplink...";
        
        // If this line runs, JS is working
        stat.innerText = customMsg; 

        if (!targetURL) { stat.innerText = "CONFIG ERROR: NO URL"; stat.style.color = "red"; }
        else { init(); }

        async function init() {
            try {
                call = window.DailyIframe.createCallObject({
                    dailyConfig: { experimentalChromeVideoMuteLightOff: true }
                });

                call.on('track-started', handleVideoStart);
                call.on('track-stopped', handleVideoStop);
                call.on('error', (e) => { stat.innerText = "ERR: " + (e.errorMsg || e); });

                // 2. JOIN ATTEMPT (v15.8 Logic)
                let isSender = (MODE === 'tablet' || MODE === 'face');
                try {
                    await call.join({ url: targetURL, userName: NAME, audioSource: isSender, videoSource: isSender });
                } catch (joinError) {
                    console.error("Join Failed", joinError);
                    stat.innerText = "CAMERA BLOCKED. RETRYING PASSIVE...";
                    await call.join({ url: targetURL, userName: NAME, audioSource: false, videoSource: false });
                    if (isSender) retryBtn.style.display = "inline-block";
                }
            } catch(e) { stat.innerText = "CRASH: " + e.message; }
        }

        function enableCamera() {
            if (call) {
                retryBtn.innerText = "ACTIVATING...";
                call.setLocalVideo(true).then(() => retryBtn.style.display = 'none');
            }
        }

        // --- SAFE FILTER LOGIC (v17.0) ---
        function handleVideoStart(e) {
            var p = e.participant;
            var track = e.track;

            // GLOBAL: Ignore Local (Unless Tablet)
            if (p.local && MODE !== 'tablet') return; 
            if (track.kind !== 'video') return; 

            // SAFETY: Ensure tracks object exists
            if (!p.tracks) return;

            // DETERMINE IF THIS TRACK IS A SCREEN SHARE
            // We check if the ID of this track matches the ID in the 'screenVideo' slot
            var isScreen = false;
            try {
                if (p.tracks.screenVideo && 
                    p.tracks.screenVideo.persistentTrack && 
                    p.tracks.screenVideo.persistentTrack.id === track.id) {
                    isScreen = true;
                }
            } catch(err) { console.log("Check error", err); }

            // MONITOR 1 (FACE) RULES
            if (MODE === 'face') {
                if (p.user_name.indexOf("Tablet") !== -1) return; // Ignore Tablet
                if (isScreen) return; // Ignore Screen Shares
            }

            // MONITOR 2 (SCREEN) RULES
            if (MODE === 'screen') {
                if (!isScreen) return; // Ignore anything that isn't a screen
            }

            // RENDER
            standby.style.display = 'none';
            container.innerHTML = ''; 
            var el = document.createElement('video');
            el.srcObject = new MediaStream([e.track]);
            el.autoplay = true; el.muted = true;
            container.appendChild(el);
            currentTrackId = e.track.id;
        }

        function handleVideoStop(e) {
            if (e.track.id === currentTrackId) {
                standby.style.display = 'block';
                container.innerHTML = '';
                currentTrackId = null;
            }
        }
    </script>
</body>
</html>
