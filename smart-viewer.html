<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Viewer v16.3</title>
    <style>
        body { 
            background: #000; margin: 0; overflow: hidden; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: sans-serif; color: white;
        }

        /* --- STANDBY GRAPHIC --- */
        #standby {
            text-align: center; z-index: 20; transition: opacity 0.5s ease; width: 80%;
        }
        .logo { font-size: 80px; margin-bottom: 30px; display: block; }
        .status-text {
            font-size: 32px; font-weight: 300; letter-spacing: 1px; color: #ccc;
            line-height: 1.5; text-transform: uppercase;
        }
        .pulse { animation: pulse-animation 2s infinite ease-in-out; }
        @keyframes pulse-animation { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- RETRY BUTTON --- */
        #retry-btn {
            display: none; margin-top: 20px; padding: 15px 30px;
            font-size: 20px; background: #FF4136; color: white; 
            border: none; border-radius: 8px; cursor: pointer; z-index: 50;
        }

        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; z-index: 10; background: black; 
        }
    </style>
</head>
<body>

    <div id="standby">
        <div class="logo">⚕️</div> 
        <div id="status" class="status-text pulse">Loading...</div>
        <button id="retry-btn" onclick="enableCamera()">⚠️ ENABLE CAMERA UPLINK</button>
    </div>

    <div id="container"></div>

    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <script>
        var params = new URLSearchParams(window.location.search);
        var MODE = params.get('mode');
        var targetURL = params.get('url') ? params.get('url').trim().replace(/"/g, '') : "";
        var NAME = params.get('name') || "Smart-Viewer";
        
        var stat = document.getElementById('status');
        var standby = document.getElementById('standby');
        var container = document.getElementById('container');
        var retryBtn = document.getElementById('retry-btn');
        var call = null;
        var currentTrackId = null;

        // 1. SET CUSTOM MESSAGES
        var customMsg = "Initializing...";
        if (MODE === 'face') customMsg = "Awaiting instructor's camera and microphone";
        if (MODE === 'screen') customMsg = "Awaiting instructor's screen share";
        if (MODE === 'tablet') customMsg = "Connecting Tablet Uplink...";
        stat.innerText = customMsg;

        if (!targetURL) { stat.innerText = "CONFIG ERROR: NO URL"; stat.style.color = "red"; }
        else { init(); }

        async function init() {
            try {
                call = window.DailyIframe.createCallObject({
                    dailyConfig: { experimentalChromeVideoMuteLightOff: true }
                });

                call.on('track-started', handleVideoStart);
                call.on('track-stopped', handleVideoStop);
                call.on('error', (e) => { stat.innerText = "ERR: " + (e.errorMsg || e); });

                // 2. JOIN ATTEMPT (FAIL-SAFE)
                let isSender = (MODE === 'tablet' || MODE === 'face');
                try {
                    await call.join({ url: targetURL, userName: NAME, audioSource: isSender, videoSource: isSender });
                } catch (joinError) {
                    console.error("Join Failed", joinError);
                    stat.innerText = "CAMERA BLOCKED. RETRYING PASSIVE...";
                    await call.join({ url: targetURL, userName: NAME, audioSource: false, videoSource: false });
                    if (isSender) retryBtn.style.display = "inline-block";
                }
            } catch(e) { stat.innerText = "CRASH: " + e.message; }
        }

        function enableCamera() {
            if (call) {
                retryBtn.innerText = "ACTIVATING...";
                call.setLocalVideo(true).then(() => retryBtn.style.display = 'none');
            }
        }

        // --- THE ROBUST LOGIC (V16.3) ---
        function handleVideoStart(e) {
            var p = e.participant;
            var track = e.track;

            // 1. GLOBAL SAFETY CHECKS
            if (p.local && MODE !== 'tablet') return; // Ignore self
            if (track.kind !== 'video') return; // Ignore audio

            // 2. MONITOR 1 (FACE) LOGIC
            if (MODE === 'face') {
                // RULE A: Ignore "Tablet" users (Fixes the Ghost Feed)
                if (p.user_name.indexOf("Tablet") !== -1) return;
                
                // RULE B: Ignore Screen Shares (Fixes the Screen duplication)
                // We verify this is the 'video' track, not 'screenVideo'
                var isScreenTrack = false;
                try {
                    if (p.tracks.screenVideo && p.tracks.screenVideo.persistentTrack && 
                        p.tracks.screenVideo.persistentTrack.id === track.id) {
                        isScreenTrack = true;
                    }
                } catch(err) { console.log("Track check error", err); }

                if (isScreenTrack) return; // If it's a screen, IGNORE IT.
            }

            // 3. MONITOR 2 (SCREEN) LOGIC
            if (MODE === 'screen') {
                // RULE: ONLY show if this specific track is the Screen Track
                var isScreenTrack = false;
                try {
                    if (p.tracks.screenVideo && p.tracks.screenVideo.persistentTrack && 
                        p.tracks.screenVideo.persistentTrack.id === track.id) {
                        isScreenTrack = true;
                    }
                } catch(err) { console.log("Track check error
