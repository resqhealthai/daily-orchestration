<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVCH V9.8 - Safe Loader</title>
    <style>
        body { 
            background: #000; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-family: monospace;
            color: white;
        }
        /* Mode Specific Backgrounds for Setup */
        body.mode-face   { background-color: #001f3f; } /* Blue */
        body.mode-screen { background-color: #111; }    /* Gray */
        body.mode-tablet { background-color: #85144b; } /* Red */

        video { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            z-index: 10; 
        }

        #ui-layer {
            z-index: 20;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            text-align: left;
        }
        .log-line { margin: 2px 0; }
        .error { color: #ff6b6b; font-weight: bold; }
        .success { color: #51cf66; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h3>V9.8 SYSTEM LOG</h3>
        <div id="console">Initializing DOM...</div>
    </div>
    <div id="container"></div>

    <script>
        // 1. GLOBAL ERROR TRAP (Must be first)
        const con = document.getElementById('console');
        window.onerror = function(msg, source, lineno) {
            const div = document.createElement('div');
            div.className = 'log-line error';
            div.innerText = `CRITICAL SYNTAX ERROR: ${msg} (Line ${lineno})`;
            con.appendChild(div);
        };

        // 2. LOGGING HELPER
        function log(msg, type='') {
            const div = document.createElement('div');
            div.className = `log-line ${type}`;
            div.innerText = `> ${msg}`;
            con.appendChild(div);
            console.log(msg);
        }

        log("JS Engine Started.", "success");

        // 3. LOAD LIBRARY (V9.6 Method)
        function loadLib() {
            log("Fetching Daily.co Library...");
            const script = document.createElement('script');
            script.src = "https://unpkg.com/@daily-co/daily-js";
            script.async = true;
            script.onload = () => {
                log("Library Loaded.", "success");
                runApp();
            };
            script.onerror = () => log("ERROR: Could not load Daily JS.", "error");
            document.head.appendChild(script);
        }

        // 4. MAIN LOGIC (V9.7 Rules)
        async function runApp() {
            try {
                const params = new URLSearchParams(window.location.search);
                const MODE = params.get('mode');
                const URL = params.get('url');
                const NAME = params.get('name') || "ResQ-Node";

                if (!URL) throw new Error("No URL in parameters.");
                document.body.classList.add(`mode-${MODE}`);
                log(`Mode: ${MODE} | Joining Room...`);

                const call = window.DailyIframe.createCallObject({
                    dailyConfig: { experimentalChromeVideoMuteLightOff: true }
                });

                // --- VIDEO FILTERING LOGIC ---
                call.on('track-started', (e) => {
                    const p = e.participant;
                    const track = e.track;
                    if (track.kind !== 'video') return;

                    let show = false;
                    
                    if (MODE === 'screen') {
                        // Monitor 2: Only Remote Screens
                        if (!p.local && p.screen) show = true;
                    } 
                    else if (MODE === 'face') {
                        // Monitor 1: Remote Faces Only (No Screens, No Tablet)
                        if (!p.local && !p.screen && !p.user_name.includes("Tablet")) show = true;
                    } 
                    else if (MODE === 'tablet') {
                        // Tablet Window: Local Self-View Only
                        if (p.local) show = true;
                    }

                    if (show) {
                        log(`Displaying feed from: ${p.user_name}`, "success");
                        const c = document.getElementById('container');
                        c.innerHTML = '';
                        const el = document.createElement('video');
                        el.srcObject = new MediaStream([track]);
                        el.autoplay = true;
                        el.muted = true;
                        c.appendChild(el);
                        document.getElementById('ui-layer').style.display = 'none';
                    }
                });

                // --- DEVICE SELECTION ---
                let vid = false;
                let aud = false;

                if (MODE !== 'screen') {
                    log("Hunting for camera...");
                    await navigator.mediaDevices.getUserMedia({ video: true });
                    const devs = await navigator.mediaDevices.enumerateDevices();
                    const vDevs = devs.filter(d => d.kind === 'videoinput');
                    
                    const keyword = (MODE === 'face') ? "Logitech" : "OBS";
                    const target = vDevs.find(d => d.label.includes(keyword));

                    if (target) {
                        log(`Found ${keyword}: ${target.label}`, "success");
                        vid = target.deviceId;
                        aud = (MODE === 'face');
                    } else {
                        log(`WARNING: '${keyword}' not found. Using default.`, "error");
                        vid = true; // Fallback
                    }
                }

                // --- JOIN ---
                await call.join({ url: URL, userName: NAME, videoSource: vid, audioSource: aud });
                
                if (MODE === 'tablet') {
                    log("Activating Tablet Uplink...");
                    call.setLocalVideo(true);
                }

            } catch (err) {
                log(`CRASH: ${err.message}`, "error");
            }
        }

        // START
        loadLib();

    </script>
</body>
</html>
