<!DOCTYPE html>
<html>
<head>
    <title>ResQ Smart Viewer</title>
    <meta charset="utf-8">
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        /* The One True Video Element */
        #the-feed {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            object-fit: contain; /* Keep aspect ratio (use 'cover' to crop) */
            z-index: 10;
        }
        /* Hidden Audio Element */
        #the-audio { display: none; }
        
        #debug {
            position: fixed; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.8);
            padding: 10px; font-family: monospace; font-size: 16px; z-index: 20; pointer-events: none; border: 1px solid #0f0;
        }
    </style>
    <script crossorigin src="https://unpkg.com/@daily-co/daily-js"></script>
</head>
<body>
    <div id="debug">Initializing Custom Viewer...</div>
    
    <!-- We build our own UI: Just one video and one audio player -->
    <video id="the-feed" autoplay playsinline></video>
    <audio id="the-audio" autoplay></audio>
    
    <script>
        let callObject = null;
        let joinStatus = "Loading SDK...";

        // 1. SDK CHECK
        const sdkCheck = setInterval(() => {
            if (window.DailyIframe) {
                clearInterval(sdkCheck);
                init();
            }
        }, 500);

        function updateDebug(msg) {
            if(msg) joinStatus = msg;
            const d = document.getElementById('debug');
            if(d) d.innerText = `Status: ${joinStatus}`;
        }

        // 2. MAIN INIT
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const roomUrl = params.get('roomUrl');
            const mode = params.get('mode') || 'face'; // 'face' or 'screen'

            if (!roomUrl) { updateDebug("Error: No roomUrl"); return; }

            // === USE CUSTOM CALL OBJECT (No UI) ===
            callObject = window.DailyIframe.createCallObject({
                subscribeToTracksAutomatically: true 
            });

            updateDebug("Joining...");

            // 3. LISTEN FOR TRACKS
            // This event fires whenever a video/audio track starts (Camera or Screen)
            callObject.on('track-started', (e) => {
                // e.participant: The user who started the track
                // e.track: The actual MediaStreamTrack (video/audio)
                
                if (e.participant.local) return; // Ignore self

                updateDebug(`Track Rx: ${e.track.kind} (${e.type})`);

                const videoTag = document.getElementById('the-feed');
                const audioTag = document.getElementById('the-audio');

                // LOGIC: ROUTE TRACKS TO TAGS
                
                if (e.track.kind === 'audio') {
                    // Always play audio (browser handles mixing)
                    // Or only play on 'face' display to prevent echo?
                    // Let's enable on both for now, rely on one display being muted physically.
                    audioTag.srcObject = new MediaStream([e.track]);
                }
                
                if (e.track.kind === 'video') {
                    // Check if this is a Screen Share or Camera
                    // daily-js marks screen video tracks explicitly
                    
                    const isScreen = (e.type === 'screenVideo'); // Daily-specific field check
                    
                    if (mode === 'face') {
                        // FACE DISPLAY: Only attach if it is NOT a screen
                        if (!isScreen) {
                            console.log("Attaching Camera to Main Display");
                            videoTag.srcObject = new MediaStream([e.track]);
                            updateDebug("Showing: Instructor Camera");
                        }
                    } 
                    else if (mode === 'screen') {
                        // SCREEN DISPLAY: Only attach if it IS a screen
                        if (isScreen) {
                            console.log("Attaching Screen to Extended Display");
                            videoTag.srcObject = new MediaStream([e.track]);
                            updateDebug("Showing: Instructor Screen");
                        }
                    }
                }
            });

            // 4. JOIN
            try {
                await callObject.join({ 
                    url: roomUrl,
                    startVideoOff: true,
                    startAudioOff: false,
                    userName: `Display-${mode.toUpperCase()}`
                });
                updateDebug("Joined (Waiting for video...)");
            } catch(e) {
                updateDebug(`Error: ${e.message}`);
            }
        }
    </script>
</body>
</html>
